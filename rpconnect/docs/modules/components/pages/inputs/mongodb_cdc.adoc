= mongodb_cdc
:type: input
:status: experimental



////
     THIS FILE IS AUTOGENERATED!

     To make changes, edit the corresponding source file under:

     https://github.com/redpanda-data/connect/tree/main/internal/impl/<provider>.

     And:

     https://github.com/redpanda-data/connect/tree/main/cmd/tools/docs_gen/templates/plugin.adoc.tmpl
////

// Â© 2024 Redpanda Data Inc.


component_type_dropdown::[]


Streams changes from a MongoDB replica set.


[tabs]
======
Common::
+
--

```yml
# Common config fields, showing default values
input:
  label: ""
  mongodb_cdc:
    url: mongodb://localhost:27017 # No default (required)
    database: "" # No default (required)
    username: ""
    password: ""
    collections: [] # No default (required)
    checkpoint_key: mongodb_cdc_checkpoint
    checkpoint_cache: "" # No default (required)
    checkpoint_interval: 5s
    checkpoint_limit: 1000
    read_batch_size: 1000
    read_max_wait: 1s
    stream_snapshot: false
    snapshot_parallelism: 1
    auto_replay_nacks: true
```

--
Advanced::
+
--

```yml
# All config fields, showing default values
input:
  label: ""
  mongodb_cdc:
    url: mongodb://localhost:27017 # No default (required)
    database: "" # No default (required)
    username: ""
    password: ""
    collections: [] # No default (required)
    checkpoint_key: mongodb_cdc_checkpoint
    checkpoint_cache: "" # No default (required)
    checkpoint_interval: 5s
    checkpoint_limit: 1000
    read_batch_size: 1000
    read_max_wait: 1s
    stream_snapshot: false
    snapshot_parallelism: 1
    snapshot_auto_bucket_sharding: false
    document_mode: update_lookup
    json_marshal_mode: canonical
    app_name: benthos
    auto_replay_nacks: true
```

--
======

Read from a MongoDB replica set using https://www.mongodb.com/docs/manual/changeStreams/[^Change Streams]. It's only possible to watch for changes when using a sharded MongoDB or a MongoDB cluster running as a replica set.

By default MongoDB does not propagate changes in all cases. In order to capture all changes (including deletes) in a MongoDB cluster one needs to enable pre and post image saving and the collection needs to also enable saving these pre and post images. For more information see https://www.mongodb.com/docs/manual/changeStreams/#change-streams-with-document-pre--and-post-images[^MongoDB documentation].

== Metadata

Each message omitted by this plugin has the following metadata:

- operation: either "create", "replace", "delete" or "update" for changes streamed. Documents from the initial snapshot have the operation set to "read".
- collection: the collection the document was written to.
- operation_time: the oplog time for when this operation occurred.
    

== Fields

=== `url`

The URL of the target MongoDB server.


*Type*: `string`


```yml
# Examples

url: mongodb://localhost:27017
```

=== `database`

The name of the target MongoDB database.


*Type*: `string`


=== `username`

The username to connect to the database.


*Type*: `string`

*Default*: `""`

=== `password`

The password to connect to the database.
[CAUTION]
====
This field contains sensitive information that usually shouldn't be added to a config directly, read our xref:configuration:secrets.adoc[secrets page for more info].
====



*Type*: `string`

*Default*: `""`

=== `collections`

The collections to stream changes from.


*Type*: `array`


=== `checkpoint_key`

Checkpoint cache key name.


*Type*: `string`

*Default*: `"mongodb_cdc_checkpoint"`

=== `checkpoint_cache`

Checkpoint cache name.


*Type*: `string`


=== `checkpoint_interval`

The interval between writing checkpoints to the cache.


*Type*: `string`

*Default*: `"5s"`

=== `checkpoint_limit`

Sorry! This field is missing documentation.


*Type*: `int`

*Default*: `1000`

=== `read_batch_size`

The batch size of documents for MongoDB to return.


*Type*: `int`

*Default*: `1000`

=== `read_max_wait`

The maximum time MongoDB waits to fulfill `read_batch_size` on the change stream before returning documents.


*Type*: `string`

*Default*: `"1s"`

=== `stream_snapshot`

If to read initial snapshot before streaming changes.


*Type*: `bool`

*Default*: `false`

=== `snapshot_parallelism`

Parallelism for snapshot phase.


*Type*: `int`

*Default*: `1`

=== `snapshot_auto_bucket_sharding`

If true, determine parallel snapshot chunks using `$bucketAuto` instead of the `splitVector` command. This allows parallel collection reading in environments where privledged access to the MongoDB cluster is not allowed such as MongoDB Atlas.


*Type*: `bool`

*Default*: `false`

=== `document_mode`

The mode in which to emit documents, specifically updates and deletes.


*Type*: `string`

*Default*: `"update_lookup"`

|===
| Option | Summary

| `partial_update`
| In this mode update operations only have a description of the update operation, which follows the following schema:
      {
        "_id": <document_id>,
        "operations": [
          # type == set means that the value was updated like so:
          # root.foo."bar.baz" = "world"
          {"path": ["foo", "bar.baz"], "type": "set", "value":"world"},
          # type == unset means that the value was deleted like so:
          # root.qux = deleted()
          {"path": ["qux"], "type": "unset", "value": null},
          # type == truncatedArray means that the array at that path was truncated to value number of elements
          # root.array = this.array.slice(2)
          {"path": ["array"], "type": "truncatedArray", "value": 2}
        ]
      }
      
| `pre_and_post_images`
| Uses pre and post image collection to emit the full documents for update and delete operations. To use and configure this mode see the setup steps in the https://www.mongodb.com/docs/manual/changeStreams/#change-streams-with-document-pre--and-post-images[^MongoDB documentation].
| `update_lookup`
| In this mode insert, replace and update operations have the full document emitted and deletes only have the _id field populated. Documents updates lookup the full document. This corresponds to the updateLookup option, see the https://www.mongodb.com/docs/manual/changeStreams/#std-label-change-streams-updateLookup[^MongoDB documentation] for more information.

|===

=== `json_marshal_mode`

The json_marshal_mode setting is optional and controls the format of the output message.


*Type*: `string`

*Default*: `"canonical"`

|===
| Option | Summary

| `canonical`
| A string format that emphasizes type preservation at the expense of readability and interoperability. That is, conversion from canonical to BSON will generally preserve type information except in certain specific cases. 
| `relaxed`
| A string format that emphasizes readability and interoperability at the expense of type preservation.That is, conversion from relaxed format to BSON can lose type information.

|===

=== `app_name`

The client application name.


*Type*: `string`

*Default*: `"benthos"`

=== `auto_replay_nacks`

Whether messages that are rejected (nacked) at the output level should be automatically replayed indefinitely, eventually resulting in back pressure if the cause of the rejections is persistent. If set to `false` these messages will instead be deleted. Disabling auto replays can greatly improve memory efficiency of high throughput streams as the original shape of the data can be discarded immediately upon consumption and mutation.


*Type*: `bool`

*Default*: `true`


